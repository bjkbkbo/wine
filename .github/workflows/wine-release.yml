name: Wine Build (Linux/macOS x64/arm64) and Release

on:
  workflow_dispatch:
  push:
    branches: [main, master]
    paths:
      - "**"
      - ".github/workflows/wine-release.yml"

permissions:
  contents: write

jobs:
  build:
    name: Build (${{ matrix.platform }} / ${{ matrix.arch }})
    runs-on: ${{ matrix.runs_on }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux
          - platform: linux
            arch: x64
            runs_on: ubuntu-latest
          - platform: linux
            arch: arm64
            # GitHub-hosted ARM runner label
            runs_on: ubuntu-24.04-arm
          # macOS
          - platform: macos
            arch: x64
            runs_on: macos-15-intel
          - platform: macos
            arch: arm64
            runs_on: macos-15

    steps:
      - uses: actions/checkout@v4

      - name: Install build dependencies (Linux)
        if: matrix.platform == 'linux'
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update

          # NOTE:
          # This repo file currently uses CRLF line endings. Bash line continuations like "\" + newline
          # can break under CRLF (the "\" is followed by "\r"), causing the next token to execute
          # as a command (e.g. "gcc-multilib: command not found").
          # Use a bash array instead of "\" continuations to be CRLF-safe.
          pkgs=(
            build-essential
            flex bison
            perl python3
            pkg-config gettext
            tar xz-utils ca-certificates

            # X11 / graphics headers
            libx11-dev libxext-dev libxrender-dev libxrandr-dev libxi-dev libxinerama-dev
            libxcursor-dev libxcomposite-dev libxdamage-dev libxfixes-dev libxmu-dev libxxf86vm-dev
            libxss-dev

            # OpenGL / EGL / Mesa
            mesa-common-dev libgl1-mesa-dev libglu1-mesa-dev libosmesa6-dev
            libegl1-mesa-dev libgbm-dev

            # Vulkan
            # NOTE: On ubuntu-latest (24.04/noble), vulkan-headers is no longer a standalone package.
            # libvulkan-dev provides the needed headers.
            libvulkan-dev mesa-vulkan-drivers

            # fonts / images
            libfreetype6-dev libfontconfig1-dev
            libjpeg-dev libpng-dev libtiff-dev libgif-dev

            # USB / device hotplug
            libusb-1.0-0-dev libudev-dev

            # printing, scanning, audio, net
            libcups2-dev libsane-dev
            libpulse-dev
            libdbus-1-dev libgphoto2-dev
            libkrb5-dev libldap2-dev libpcap-dev

            # multimedia (ffmpeg + gstreamer)
            libavcodec-dev libavformat-dev libavutil-dev libswresample-dev libswscale-dev
            libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev

            # runtime fonts (avoid EULA prompts like ttf-mscorefonts-installer)
            fontconfig fonts-dejavu-core fonts-liberation fonts-noto-core
          )

          # gcc-multilib/g++-multilib only exist on amd64; arm64 runners don't provide them.
          # They are only required for the separate wow64 job, but keeping them on linux/x64 is harmless.
          if [ "${{ matrix.arch }}" = "x64" ]; then
            pkgs+=(gcc-multilib g++-multilib)
          fi

          sudo apt-get install -y --no-install-recommends "${pkgs[@]}"

      - name: Install build dependencies (macOS)
        if: matrix.platform == 'macos'
        shell: bash
        run: |
          set -euo pipefail
          export HOMEBREW_NO_AUTO_UPDATE=1
          export HOMEBREW_NO_INSTALL_CLEANUP=1

          # Parser tools required by Wine build system
          brew list bison >/dev/null 2>&1 || brew install bison
          brew list flex >/dev/null 2>&1 || brew install flex

          # Core deps (FreeType/fontconfig to avoid missing FreeType warnings)
          brew list pkg-config >/dev/null 2>&1 || brew install pkg-config
          brew list gettext >/dev/null 2>&1 || brew install gettext
          brew list freetype >/dev/null 2>&1 || brew install freetype
          brew list fontconfig >/dev/null 2>&1 || brew install fontconfig
          brew list jpeg-turbo >/dev/null 2>&1 || brew install jpeg-turbo
          brew list libpng >/dev/null 2>&1 || brew install libpng
          brew list libtiff >/dev/null 2>&1 || brew install libtiff

          # X11 / EGL on macOS: use XQuartz (provides /opt/X11)
          brew list --cask xquartz >/dev/null 2>&1 || brew install --cask xquartz

          # Multimedia support
          brew list ffmpeg >/dev/null 2>&1 || brew install ffmpeg
          brew list gstreamer >/dev/null 2>&1 || brew install gstreamer
          brew list gst-plugins-base >/dev/null 2>&1 || brew install gst-plugins-base

          # USB support
          brew list libusb >/dev/null 2>&1 || brew install libusb

          # Vulkan on macOS: headers + MoltenVK (Vulkan-over-Metal)
          brew list vulkan-headers >/dev/null 2>&1 || brew install vulkan-headers
          brew list molten-vk >/dev/null 2>&1 || brew install molten-vk

          # PE cross-compilation tools:
          # Wine on aarch64 requires PE cross tools (clang -target aarch64-windows + llvm-dlltool + lld).
          # Homebrew llvm provides llvm-dlltool; lld is a separate formula.
          #
          # Avoid `brew tap mstorsjo/llvm-mingw` because it may require git network auth in CI.
          if [ "${{ matrix.arch }}" = "arm64" ]; then
            brew list llvm >/dev/null 2>&1 || brew install llvm
            brew list lld >/dev/null 2>&1 || brew install lld

            # Prepend (GITHUB_PATH prepends) so configure uses brewed clang/llvm-dlltool/lld
            echo "$(brew --prefix llvm)/bin" >> "$GITHUB_PATH"
            echo "$(brew --prefix lld)/bin" >> "$GITHUB_PATH"
          fi

          # Ensure brewed bison/flex/gettext are found before the system versions
          echo "$(brew --prefix bison)/bin" >> "$GITHUB_PATH"
          echo "$(brew --prefix flex)/bin" >> "$GITHUB_PATH"
          echo "$(brew --prefix gettext)/bin" >> "$GITHUB_PATH"

      - name: Configure (out-of-tree in build/)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p build
          cd build

          # Wine recommends building out-of-tree; user requested building under build/.
          #
          # Linux: force PulseAudio driver (and disable ALSA to avoid accidentally selecting it).
          # macOS: Pulse/ALSA/OSS are Linux-specific; rely on macOS audio stack.
          CONFIG_FLAGS=(--prefix=/usr --disable-tests --enable-win64)

          if [ "${{ matrix.platform }}" = "linux" ]; then
            CONFIG_FLAGS+=(--with-pulse --without-alsa --without-oss)
          fi

          if [ "${{ matrix.platform }}" = "macos" ]; then
            # If XQuartz is present, help configure find its .pc files/headers/libs.
            if [ -d /opt/X11 ]; then
              export PKG_CONFIG_PATH="/opt/X11/lib/pkgconfig:${PKG_CONFIG_PATH:-}"
              export CPPFLAGS="-I/opt/X11/include ${CPPFLAGS:-}"
              export LDFLAGS="-L/opt/X11/lib ${LDFLAGS:-}"
            fi
          fi

          ../configure "${CONFIG_FLAGS[@]}"

      - name: Build
        shell: bash
        run: |
          set -euo pipefail
          cd build
          if command -v nproc >/dev/null 2>&1; then
            JOBS="$(nproc)"
          else
            JOBS="$(sysctl -n hw.ncpu)"
          fi
          make -j"$JOBS"

      - name: Install into staging (DESTDIR)
        shell: bash
        run: |
          set -euo pipefail
          cd build
          rm -rf install
          make install DESTDIR="$PWD/install"

      - name: Create .tar.xz package
        shell: bash
        run: |
          set -euo pipefail
          cd build

          # Create tar first, then xz-compress -> .tar.xz
          base="wine-${{ matrix.platform }}-${{ matrix.arch }}"
          tar -cvf "${base}.tar" -C install .
          xz -T0 -9 "${base}.tar"
          ls -la "${base}.tar.xz"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: wine-${{ matrix.platform }}-${{ matrix.arch }}
          path: build/wine-${{ matrix.platform }}-${{ matrix.arch }}.tar.xz

  build-linux-wow64:
    name: Build wow64 (Linux x64 32+64)
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4

      - name: Install 64-bit deps (same as normal job)
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update

          # CRLF-safe: avoid "\" line continuations
          pkgs=(
            build-essential flex bison perl python3 pkg-config gettext tar xz-utils ca-certificates
            gcc-multilib g++-multilib
            libfreetype6-dev libfontconfig1-dev
            libgl1-mesa-dev
            libx11-dev libxcursor-dev libxi-dev libxext-dev libxrandr-dev libxinerama-dev libxcomposite-dev libxss-dev
            libvulkan-dev
            rsync
          )
          sudo apt-get install -y --no-install-recommends "${pkgs[@]}"

      - name: Build 64-bit tree (--enable-win64)
        shell: bash
        run: |
          set -euxo pipefail
          mkdir -p build64
          cd build64
          ../configure --enable-win64 --prefix=/usr
          make -j"$(nproc)"
          make install DESTDIR="$PWD/inst64"

      - name: Install 32-bit cross deps
        shell: bash
        run: |
          set -euo pipefail
          sudo dpkg --add-architecture i386
          sudo apt-get update

          # CRLF-safe: avoid "\" line continuations
          pkgs=(
            gcc-multilib g++-multilib
            libfreetype6-dev:i386 libfontconfig1-dev:i386
            libgl1-mesa-dev:i386 libx11-dev:i386
            libxcursor-dev:i386 libxi-dev:i386 libxext-dev:i386 libxrandr-dev:i386
          )
          sudo apt-get install -y --no-install-recommends "${pkgs[@]}"

      - name: Build 32-bit tree (--with-wine64)
        shell: bash
        run: |
          set -euxo pipefail
          mkdir -p build32
          cd build32
          ../configure --with-wine64=../build64/inst64/usr --prefix=/usr
          make -j"$(nproc)"
          make install DESTDIR="$PWD/inst32"

      - name: Merge installs & package
        shell: bash
        run: |
          set -euxo pipefail
          mkdir -p dist
          rsync -a build64/inst64/ dist/
          rsync -a build32/inst32/ dist/
          tar -cvf wine-wow64-linux-x64.tar -C dist .
          xz -T0 -9 wine-wow64-linux-x64.tar
          ls -lh wine-wow64-linux-x64.tar.xz

      - uses: actions/upload-artifact@v4
        with:
          name: wine-wow64-linux-x64
          path: wine-wow64-linux-x64.tar.xz

  release:
    name: Create GitHub Release (YYYYMMDD tag)
    needs: [build, build-linux-wow64]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: List downloaded artifacts
        shell: bash
        run: |
          set -e
          ls -Rlah dist

      - name: Set DATE (YYYYMMDD)
        shell: bash
        run: |
          echo "DATE=$(date +'%Y%m%d')" >> "$GITHUB_ENV"

      - name: Create Release and upload .tar.xz files
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.DATE }}
          name: Release ${{ env.DATE }}
          files: |
            dist/**/*.tar.xz
          draft: false
          prerelease: false
          fail_on_unmatched_files: true
          token: ${{ secrets.GITHUB_TOKEN }}
